{"version":3,"file":"emotion-detection.js","sources":["../src/Camera.js","../src/FaceMesh.js","../src/EmotionDetection.js"],"sourcesContent":["// Camera.js\nexport class Camera {\n  constructor(videoElement, options) {\n    this.videoElement = videoElement;\n    this.options = options;\n  }\n\n  async start() {\n    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {\n      const stream = await navigator.mediaDevices.getUserMedia({\n        video: {\n          width: this.options.width,\n          height: this.options.height\n        }\n      });\n\n      this.videoElement.srcObject = stream;\n      this.videoElement.onloadedmetadata = () => {\n        this.videoElement.play();\n        this.loop();\n      };\n    }\n  }\n\n  loop() {\n    if (this.options.onFrame) {\n      this.options.onFrame();\n    }\n    requestAnimationFrame(() => this.loop());\n  }\n\n  stop() {\n    if (this.videoElement.srcObject) {\n      this.videoElement.srcObject.getTracks().forEach(track => track.stop());\n    }\n  }\n}\n","// FaceMesh.js\nexport class FaceMesh {\n  constructor(options) {\n    this.options = options;\n    this.onResultsCallback = null;\n  }\n\n  setOptions(options) {\n    this.options = { ...this.options, ...options };\n  }\n\n  onResults(callback) {\n    this.onResultsCallback = callback;\n  }\n\n  async send({ image }) {\n    // Implementasi FaceMesh dari MediaPipe\n    // Ini adalah placeholder, Anda perlu mengimplementasikan logika yang sesuai\n    if (this.onResultsCallback) {\n      this.onResultsCallback({ image, multiFaceLandmarks: [] });\n    }\n  }\n}\n","// EmotionDetection.js\nimport { Camera } from './Camera.js';\nimport { FaceMesh } from './FaceMesh.js';\n\nexport class EmotionDetection {\n  constructor(videoElement, canvasElement, options = {}) {\n    this.videoElement = videoElement;\n    this.canvasElement = canvasElement;\n    this.canvasCtx = canvasElement.getContext('2d');\n    this.lastFaceID = null;\n    this.options = {\n      maxNumFaces: 1,\n      refineLandmarks: true,\n      minDetectionConfidence: 0.5,\n      minTrackingConfidence: 0.5,\n      ...options\n    };\n\n    this.EMOTION_THRESHOLDS = {\n      HAPPY: 0.65,\n      SAD: 0.6,\n      ANGRY: 0.55,\n      SURPRISED: 0.5,\n      NEUTRAL: 0.7\n    };\n\n    this.initializeFaceMesh();\n  }\n\n  async initializeFaceMesh() {\n    this.faceMesh = new FaceMesh({\n      locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`\n    });\n\n    this.faceMesh.setOptions(this.options);\n    this.faceMesh.onResults(this.onResults.bind(this));\n  }\n\n  start() {\n    this.camera = new Camera(this.videoElement, {\n      onFrame: async () => {\n        await this.faceMesh.send({ image: this.videoElement });\n      },\n      width: 640,\n      height: 480\n    });\n\n    return this.camera.start();\n  }\n\n  stop() {\n    if (this.camera) {\n      this.camera.stop();\n    }\n  }\n\n  onResults(results) {\n    this.canvasCtx.save();\n    this.canvasCtx.clearRect(0, 0, this.canvasElement.width, this.canvasElement.height);\n    this.canvasCtx.drawImage(results.image, 0, 0, this.canvasElement.width, this.canvasElement.height);\n\n    let currentFaceID = '';\n    if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {\n      const landmarks = results.multiFaceLandmarks[0];\n      currentFaceID = this.generateFaceID(landmarks);\n\n      if (currentFaceID !== this.lastFaceID) {\n        document.head.setAttribute('FaceID', currentFaceID);\n        this.lastFaceID = currentFaceID;\n      }\n\n      const emotions = this.analyzeEmotions(landmarks);\n      this.updateUI(emotions);\n\n      results.multiFaceLandmarks.forEach(landmarks => {\n        this.drawLandmarks(landmarks);\n      });\n    } else {\n      if (this.lastFaceID !== null) {\n        document.head.setAttribute('FaceID', '');\n        this.lastFaceID = null;\n      }\n    }\n\n    this.canvasCtx.restore();\n  }\n\n  generateFaceID(landmarks) {\n    let hashString = landmarks.map(lm =>\n      lm.x.toFixed(4) +\n      lm.y.toFixed(4) +\n      lm.z.toFixed(4)\n    ).join('');\n\n    return this.djb2Hash(hashString).toString(16);\n  }\n\n  djb2Hash(str) {\n    let hash = 5381;\n    for (let i = 0; i < str.length; i++) {\n      hash = (hash * 33) ^ str.charCodeAt(i);\n    }\n    return hash >>> 0;\n  }\n\n  analyzeEmotions(landmarks) {\n    const emotions = {\n      happy: this.calculateHappiness(landmarks),\n      sad: this.calculateSadness(landmarks),\n      angry: this.calculateAnger(landmarks),\n      surprised: this.calculateSurprise(landmarks),\n      neutral: this.calculateNeutral(landmarks)\n    };\n\n    const total = Object.values(emotions).reduce((a, b) => a + b, 0);\n    Object.keys(emotions).forEach(key => {\n      emotions[key] = (emotions[key] / total * 100).toFixed(1);\n    });\n\n    return emotions;\n  }\n\n  calculateHappiness(landmarks) {\n    const lipCornerLeft = landmarks[61];\n    const lipCornerRight = landmarks[291];\n    const lipStretch = Math.hypot(\n      lipCornerRight.x - lipCornerLeft.x,\n      lipCornerRight.y - lipCornerLeft.y\n    );\n\n    const cheekLeft = landmarks[123];\n    const eyeLeft = landmarks[159];\n    const cheekRaiseLeft = eyeLeft.y - cheekLeft.y;\n\n    if (!landmarks[61] || !landmarks[291] || !landmarks[123] || !landmarks[159]) {\n      return 0;\n    }\n\n    return Math.min(1, lipStretch * 2 + cheekRaiseLeft * 3);\n  }\n\n  calculateSadness(landmarks) {\n    const lipCornerLeft = landmarks[61];\n    const lipBottom = landmarks[17];\n    const lipDepression = lipBottom.y - lipCornerLeft.y;\n\n    const browInnerLeft = landmarks[105];\n    const browInnerRight = landmarks[334];\n    const browRaise = (browInnerLeft.y + browInnerRight.y) / 2;\n\n    return Math.min(1, lipDepression * 1.5 + browRaise * 2);\n  }\n\n  calculateAnger(landmarks) {\n    const browOuterLeft = landmarks[46];\n    const browInnerLeft = landmarks[105];\n    const browLowerLeft = browInnerLeft.y - browOuterLeft.y;\n\n    const lipTop = landmarks[0];\n    const lipBottom = landmarks[17];\n    const lipCompression = lipBottom.y - lipTop.y;\n\n    return Math.min(1, browLowerLeft * 2 + lipCompression * 1.2);\n  }\n\n  calculateSurprise(landmarks) {\n    const eyelidLeft = landmarks[159];\n    const eyeLeft = landmarks[145];\n    const eyeOpenness = eyeLeft.y - eyelidLeft.y;\n\n    const chin = landmarks[152];\n    const nose = landmarks[4];\n    const jawDrop = chin.y - nose.y;\n\n    return Math.min(1, eyeOpenness * 2 + jawDrop * 0.8);\n  }\n\n  calculateNeutral(landmarks) {\n    let deviation = 0;\n    const neutralFeatures = [\n      [152, 4],  // Chin to nose\n      [61, 291], // Lip corners\n      [105, 334] // Brows\n    ];\n\n    neutralFeatures.forEach(([i1, i2]) => {\n      deviation += Math.hypot(\n        landmarks[i1].x - landmarks[i2].x,\n        landmarks[i1].y - landmarks[i2].y\n      );\n    });\n\n    return Math.max(0, 1 - deviation * 2);\n  }\n\n  getMentalHealthConclusion(emotions) {\n    const { happy, sad, angry, surprised, neutral } = emotions;\n\n    if (sad > 40 && happy < 20 && neutral < 30) {\n      return {\n        conclusion: \"Potensi gejala depresi terdeteksi\",\n        advice: \"Rekomendasi: Konsultasi dengan profesional kesehatan mental. Pola emosi menunjukkan tanda-tanda depresi.\\nKunjungi Media Sosial Berikut Untuk Berkonsultasi\\n https://www.instagram.com/peercounselor.unnes?igsh=MXhodHc0bmhpdGdnag==\"\n      };\n    }\n\n    if (angry > 35 && happy < 25) {\n      return {\n        conclusion: \"Tingkat stres tinggi terdeteksi\",\n        advice: \"Rekomendasi: Lakukan teknik relaksasi dan perhatikan pola tidur.\"\n      };\n    }\n\n    if (neutral > 60) {\n      return {\n        conclusion: \"Emosi stabil\",\n        advice: \"Pertahankan keseimbangan emosional. Tidak terdeteksi masalah kesehatan mental signifikan.\"\n      };\n    }\n\n    return {\n      conclusion: \"Kondisi emosional normal\",\n      advice: \"Tidak terdeteksi gangguan mental utama. Tetap pantau kesehatan emosi Anda.\"\n    };\n  }\n\n  updateUI(emotions) {\n    Object.entries(emotions).forEach(([emotion, value]) => {\n      document.getElementById(emotion).textContent = value;\n    });\n\n    const mentalHealth = this.getMentalHealthConclusion(emotions);\n    document.getElementById(\"conclusion\").textContent = mentalHealth.conclusion;\n    document.getElementById(\"advice\").innerHTML = this.autoLinkify(mentalHealth.advice);\n  }\n\n  autoLinkify(text) {\n    return text.replace(/(https?:\\/\\/[^\\s]+)/g, url => `<a href='${url}' target='_blank' title='${url}'>${url}</a>`);\n  }\n\n  drawLandmarks(landmarks) {\n    this.canvasCtx.fillStyle = '#00FF00';\n    landmarks.forEach(landmark => {\n      const x = landmark.x * this.canvasElement.width;\n      const y = landmark.y * this.canvasElement.height;\n\n      this.canvasCtx.beginPath();\n      this.canvasCtx.arc(x, y, 1, 0, 1 * Math.PI);\n      this.canvasCtx.fill();\n    });\n  }\n}\n"],"names":["Camera","constructor","videoElement","options","this","start","navigator","mediaDevices","getUserMedia","stream","video","width","height","srcObject","onloadedmetadata","play","loop","onFrame","requestAnimationFrame","stop","getTracks","forEach","track","FaceMesh","onResultsCallback","setOptions","onResults","callback","send","image","multiFaceLandmarks","canvasElement","canvasCtx","getContext","lastFaceID","maxNumFaces","refineLandmarks","minDetectionConfidence","minTrackingConfidence","EMOTION_THRESHOLDS","HAPPY","SAD","ANGRY","SURPRISED","NEUTRAL","initializeFaceMesh","faceMesh","locateFile","file","bind","camera","async","results","save","clearRect","drawImage","currentFaceID","length","landmarks","generateFaceID","document","head","setAttribute","emotions","analyzeEmotions","updateUI","drawLandmarks","restore","hashString","map","lm","x","toFixed","y","z","join","djb2Hash","toString","str","hash","i","charCodeAt","happy","calculateHappiness","sad","calculateSadness","angry","calculateAnger","surprised","calculateSurprise","neutral","calculateNeutral","total","Object","values","reduce","a","b","keys","key","lipCornerLeft","lipCornerRight","lipStretch","Math","hypot","cheekLeft","cheekRaiseLeft","min","lipDepression","browInnerLeft","browInnerRight","browRaise","browOuterLeft","browLowerLeft","lipTop","lipCompression","eyelidLeft","eyeOpenness","chin","nose","jawDrop","deviation","i1","i2","max","getMentalHealthConclusion","conclusion","advice","entries","emotion","value","getElementById","textContent","mentalHealth","innerHTML","autoLinkify","text","replace","url","fillStyle","landmark","beginPath","arc","PI","fill"],"mappings":"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"}