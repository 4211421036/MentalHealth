name: Security Hardening
on: [push, schedule]

jobs:
  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Erlang
        uses: erlef/setup-beam@v1
        with:
          otp-version: '26.0'  # Gunakan versi terbaru

      - name: Compile Erlang modules
        run: |
          erlc ip_blocker.erl security_monitor.erl mini_waf.erl
          ls *.beam  # Verifikasi file beam terbuat

      - name: Run Security Systems
        run: |
          erl -pa . -noshell -eval '
            application:start(crypto),
            application:start(inets),
            code:load_file(ip_blocker),
            code:load_file(security_monitor),
            ip_blocker:start_link(),
            security_monitor:start(),
            lists:foreach(fun(IP) -> ip_blocker:block_ip(IP) end, [
                "1.1.1.1", "2.2.2.2"
            ]),
            timer:sleep(2000),  # Beri waktu untuk inisialisasi
            init:stop()
          '

      - name: Deploy WAF Rules
        run: |
          # Tetap pertahankan bagian Cloudflare
          curl -X PUT "https://api.cloudflare.com/client/v4/zones/bab32fe292310337a52c8dbaac93e34a/firewall/rules" \
          -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_KEY }}" \
          -H "Content-Type: application/json" \
          --data '{"rules": [{"filter": {"expression": "(http.request.uri.path contains '\''/wp-admin'\'')"},"action": "block"}]}'
